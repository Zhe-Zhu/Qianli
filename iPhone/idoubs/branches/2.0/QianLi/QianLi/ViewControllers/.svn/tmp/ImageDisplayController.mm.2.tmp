//
//  ImageDisplayController.m
//  QianLi
//
//  Created by lutan on 8/27/13.
//  Copyright (c) 2013 Chen Xiangwen. All rights reserved.
//

#import "ImageDisplayController.h"
#import "SipStackUtils.h"
#import "MobClick.h"

@interface ImageDisplayController (){
    UILongPressGestureRecognizer *_longPress;
    UITapGestureRecognizer *_tapGesture;
    CGPoint firstPoint;
}

@property(nonatomic) NSInteger currentPage;
@property (weak, nonatomic) IBOutlet UIScrollView *imageScrollView;
@property (strong, nonatomic) IBOutlet UILabel *indicator;
@property (weak, nonatomic) DoodleBackView *doodlebackView;
@property(nonatomic) double starTime;
@property (weak, nonatomic) IBOutlet UIButton *addButton;
@property (weak, nonatomic) IBOutlet UIButton *doodleButton;
@property (weak, nonatomic) IBOutlet UIToolbar *toolBar;
@property (weak, nonatomic) UINavigationController *addMoreImagesController;
@property (weak, nonatomic) UIView *doodleToolBar;

- (IBAction)addMoreImage:(id)sender;
- (IBAction)doodle:(id)sender;

@end

@implementation ImageDisplayController

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}

- (void)viewDidLoad
{
    [super viewDidLoad];
	// Do any additional setup after loading the view.
    UIBarButtonItem *cancelButton = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemCancel target:self action:@selector(cancel)];
    self.navigationItem.leftBarButtonItem = cancelButton;
    
//    UIScrollView *scrollView = [[UIScrollView alloc] initWithFrame:CGRectMake(0, 64, PageWidth, 377)];
    UIScrollView *scrollView = [[UIScrollView alloc] initWithFrame:CGRectMake(0, 0, PageWidth, [UIScreen mainScreen].bounds.size.height)];
    _imageScrollView = scrollView;
    _imageScrollView.backgroundColor = [UIColor colorWithRed:245 / 255.0 green:245 / 255.0 blue:245 / 255.0 alpha:1.0];
    _imageScrollView.pagingEnabled = YES;
    _imageScrollView.alwaysBounceVertical = NO;
    _imageScrollView.directionalLockEnabled = YES;
    _imageScrollView.contentOffset = CGPointMake(0, 0);
    _imageScrollView.delegate = self;
    _imageScrollView.showsHorizontalScrollIndicator = NO;
    
    [self.view addSubview:_imageScrollView];
    [self.view bringSubviewToFront:_toolBar];
    UIImageView *selectingImageView = (UIImageView *)[self.view viewWithTag:kSelectingImageTag];
    [self.view bringSubviewToFront:selectingImageView];
    _currentPage = 1;
    
    // Add long press gesture recognizer
    _longPress = [[UILongPressGestureRecognizer alloc] initWithTarget:self action:@selector(handleLongPress:)];
    _longPress.minimumPressDuration = 1.0;
    _longPress.delegate = self;
    [_imageScrollView addGestureRecognizer:_longPress];
    
    // 加入轻点(Tap gesture)
    _tapGesture = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(handleTap:)];
    _tapGesture.delegate = self;
    [_imageScrollView addGestureRecognizer:_tapGesture];
    
    _starTime = [[NSDate date] timeIntervalSince1970];
    // Pan guesture
    [_addButton setTitle:@"继续添加" forState:UIControlStateNormal];
    [_doodleButton setTitle:@"涂鸦" forState:UIControlStateNormal];
    
    _indicator = [[UILabel alloc] initWithFrame:CGRectMake(160-50, 1, 100, _toolBar.frame.size.height)];
    _indicator.textAlignment = NSTextAlignmentCenter;
    _indicator.font = [UIFont fontWithName:@"AvenirNext-Bold" size:16];
    [_toolBar addSubview:_indicator];
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    
    [self displayImages];
    //[self setIndicator];
    
    [MobClick beginEvent:@"sharePhotos"];
}

- (void)viewDidAppear:(BOOL)animated
{
    [super viewDidAppear:animated];
}

- (void)viewWillDisappear:(BOOL)animated
{
    [super viewWillDisappear:animated];
    
    // 将status bar设置为正常状态
    [[UIApplication sharedApplication] setStatusBarHidden:NO];
    
    [MobClick endEvent:@"sharePhotos" label:[NSString stringWithFormat:@"%d", [_images count]]];
}

- (void)displayImages
{
    if ([_images count] > 0) {
        UIImageView *selectingView = (UIImageView *)[self.view viewWithTag:kSelectingImageTag];
        [selectingView removeFromSuperview];
    }
    
    CGRect frame = _imageScrollView.frame;
    _imageScrollView.contentSize = CGSizeMake(PageWidth * _totalNumber, frame.size.height);
    CGPoint offset = _imageScrollView.contentOffset;
    _imageScrollView.contentOffset = CGPointMake(offset.x, 0);
    for (int i = 0; i < _totalNumber; ++i) {
        int ind = [_indexs indexOfObject:[NSString stringWithFormat:@"%d",i]];
        UIImage *image = nil;
        if (ind == NSNotFound) {
            if (![_imageScrollView viewWithTag:1000 + i]) {
                image = [UIImage imageNamed:@"blankImage.png"];
                CGSize newImageSize = [self adjustImageFrame:image.size];
                UIView *contentView = [[UIImageView alloc] initWithFrame:CGRectMake(i * PageWidth, 0, 320, frame.size.height)];
                UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake((320-newImageSize.width)/2, (frame.size.height-newImageSize.height)/2, newImageSize.width, newImageSize.height)];
                
                imageView.image = image;
                imageView.tag = kImageViewTagInContentView; // 该数字无意义, 单纯只为获取imageView而已
                contentView.tag = 1000 + i;
                [contentView addSubview:imageView];
                [_imageScrollView addSubview:contentView];
            }
            else{
                image = [UIImage imageNamed:@"blankImage.png"];
                UIView * contentView = (UIView *)[_imageScrollView viewWithTag:1000+i];
                UIImageView *imageView = (UIImageView *)[contentView viewWithTag:kImageViewTagInContentView];
                CGSize newImageSize = [self adjustImageFrame:image.size];
                imageView.frame = CGRectMake((320-newImageSize.width)/2, (frame.size.height-newImageSize.height)/2, newImageSize.width, newImageSize.height);
                imageView.image = image;
            }
        }
        else{
            if (![_imageScrollView viewWithTag:1000 + i]) {
                if (ind < [_images count]) {
                    image = [_images objectAtIndex:ind];
                }
                CGSize newImageSize = [self adjustImageFrame:image.size];
                UIView *contentView = [[UIImageView alloc] initWithFrame:CGRectMake(i * PageWidth, 0, 320, frame.size.height)];
                UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake((320-newImageSize.width)/2, (frame.size.height-newImageSize.height)/2, newImageSize.width, newImageSize.height)];
                
                imageView.image = image;
                imageView.tag = kImageViewTagInContentView; // 该数字无意义, 单纯只为获取imageView而已
                contentView.tag = 1000 + i;
                [contentView addSubview:imageView];
                [_imageScrollView addSubview:contentView];
            }
            else{
                if (ind < [_images count]) {
                    image = [_images objectAtIndex:ind];
                    NSLog(@"%d", image.imageOrientation);
                }
//                UIImageView *imageView = (UIImageView *)[_imageScrollView viewWithTag:1000 + i];
                UIView * contentView = (UIView *)[_imageScrollView viewWithTag:1000+i];
                UIImageView *imageView = (UIImageView *)[contentView viewWithTag:kImageViewTagInContentView];
                CGSize newImageSize = [self adjustImageFrame:image.size];
                imageView.frame = CGRectMake((320-newImageSize.width)/2, (frame.size.height-newImageSize.height)/2, newImageSize.width, newImageSize.height);
                imageView.image = image;
            }
        }
    }
    [self setIndicator];
}

- (CGSize)adjustImageFrame:(CGSize)imageSize
{
    // 调节图片的大小, 使其适应屏幕
    // 目标: 在不拉伸图片的时候使其充满屏幕
    CGFloat width = [UIScreen mainScreen].bounds.size.width;
    CGFloat height = [UIScreen mainScreen].bounds.size.height;
    CGSize newImageSize = imageSize;
    
    if ((imageSize.width / imageSize.height) <= (width / height)) {
        newImageSize.height = height;
        newImageSize.width = imageSize.width * height / imageSize.height;
    }
    else {
        newImageSize.width = width;
        newImageSize.height = imageSize.height * width / imageSize.width;
    }
    
    return newImageSize;
}

- (void)displaySelectingState
{
//    _totalNumber ++;
//    // 增加一个空白的占位符
//    [self displayImages];
//    _totalNumber --;
//    // 将占位符移除
//    UIView *contentView = (UIView *)[_imageScrollView viewWithTag:1000 + _totalNumber];
//    [contentView removeFromSuperview];
    
    UIImageView *selectingImageView = [[UIImageView alloc] init];
    if (abs([UIScreen mainScreen].bounds.size.height - 568) < 2) {
        selectingImageView.frame = CGRectMake(0, 0, 320, 568);
        selectingImageView.image = [UIImage imageNamed:@"choosingImages.png"];
    }
    else {
        selectingImageView.frame = CGRectMake(0, 0, 320, 480);
        selectingImageView.image = [UIImage imageNamed:@"choosingImagesShort.png"];
    }
    selectingImageView.tag = kSelectingImageTag;
    [self.view addSubview:selectingImageView];
}

# pragma -- UIScrollView Delegate

- (void)scrollViewDidScroll:(UIScrollView *)scrollView
{
    if ([_imageScrollView viewWithTag:99999]) {
        [_imageScrollView viewWithTag:99999].hidden = YES;
    }
}

- (void)scrollViewDidEndDecelerating:(UIScrollView *)scrollView
{
    [self setIndicator];
    NSString *remotePartyNumber = [[SipStackUtils sharedInstance] getRemotePartyNumber];
    NSString *str = [NSString stringWithFormat:@"%@%@%f",kScrollOffset,kSeparator,_imageScrollView.contentOffset.x];
    [[SipStackUtils sharedInstance].messageService sendMessage:str toRemoteParty:remotePartyNumber];
}

- (void)setIndicator
{
    CGFloat offsetX = _imageScrollView.contentOffset.x;
    _currentPage = roundf(offsetX / PageWidth) + 1;
    _indicator.text = [NSString stringWithFormat:@"%d / %d",_currentPage,_totalNumber];
}

-(void)handleLongPress:(UILongPressGestureRecognizer *)longPress
{
    CGPoint location = [longPress locationInView:_imageScrollView];
    // 获取当前图片的高度信息, 用于调整indicator位置
    int i = location.x / 320;
    CGFloat height = [UIScreen mainScreen].bounds.size.height;
    CGFloat minY = 0;
    if ([_imageScrollView viewWithTag:1000 + i]) {
        UIView *contentView = [_imageScrollView viewWithTag:1000 + i];
        UIImageView *imageView = (UIImageView *)[contentView viewWithTag:kImageViewTagInContentView];
        height = imageView.frame.size.height;
        minY = imageView.frame.origin.y;
    }
    CGPoint locationRatio = CGPointMake(location.x/[UIScreen mainScreen].bounds.size.width, (location.y-minY)/height);
    [self showLongPressIndicator: locationRatio];
    
    // 发送位置信息
    // 发送的为占据屏幕的比例
    NSString *remotePartyNumber = [[SipStackUtils sharedInstance] getRemotePartyNumber];
    NSString *message = [NSString stringWithFormat:@"%@%@%f%@%f", kLongPressIndicator, kSeparator, locationRatio.x, kSeparator, locationRatio.y];
    [[SipStackUtils sharedInstance].messageService sendMessage:message toRemoteParty:remotePartyNumber];
}

- (void)showLongPressIndicator:(CGPoint) locationRatio
{
    // 获取图片高度信息
    int i = locationRatio.x * [UIScreen mainScreen].bounds.size.width / 320;
    CGFloat height = [UIScreen mainScreen].bounds.size.height;
    CGFloat minY = 0;
    if ([_imageScrollView viewWithTag:1000 + i]) {
        UIView *contentView = [_imageScrollView viewWithTag:1000 + i];
        UIImageView *imageView = (UIImageView *)[contentView viewWithTag:kImageViewTagInContentView];
        height = imageView.frame.size.height;
        minY = imageView.frame.origin.y;
    }
    CGPoint location = CGPointMake(locationRatio.x * [UIScreen mainScreen].bounds.size.width, locationRatio.y * height + minY);
    if ([_imageScrollView viewWithTag:99999]) {
        [_imageScrollView viewWithTag:99999].frame = CGRectMake(location.x - 15, location.y - 15 , 30, 30);
        [_imageScrollView bringSubviewToFront:[_imageScrollView viewWithTag:99999]];
        [_imageScrollView viewWithTag:99999].hidden = NO;
    }
    else{
        UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake(location.x - 15, location.y - 15 , 30, 30)];
        imageView.image = [UIImage imageNamed:@"punctuate.png"];
        [_imageScrollView addSubview:imageView];
        imageView.tag = 99999;
    }
}

- (void)handleTap:(UITapGestureRecognizer *)tapGesture
{
    [self.navigationController setNavigationBarHidden:!self.navigationController.navigationBarHidden animated:YES];
    [[UIApplication sharedApplication] setStatusBarHidden:self.navigationController.navigationBarHidden];
    [UIView animateWithDuration:0.6 animations:^{
        _toolBar.hidden = !_toolBar.hidden;
        if (self.navigationController.navigationBarHidden) {
            _imageScrollView.backgroundColor = [UIColor blackColor];
        }
        else {
            _imageScrollView.backgroundColor = [UIColor whiteColor];
        }
    }];
}

- (void)cancel
{
    [self cancelFromRemoteyParty];
    NSString *remotePartyNumber = [[SipStackUtils sharedInstance] getRemotePartyNumber];
    [[SipStackUtils sharedInstance].messageService sendMessage:kDoodleCancel toRemoteParty:remotePartyNumber];
}

- (void)cancelFromRemoteyParty
{
    if (!_doodlebackView) {
        [self.navigationController popViewControllerAnimated:YES];
        [PictureManager endImageSession:[[PictureManager sharedInstance] getImageSession] Success:^(BOOL success) {
            NSLog(@"end session");
        }];
        
        // Add to history
        NSMutableArray *array = [NSMutableArray array];
        for (UIImage *image in _images) {
            [array addObject:[image imageByResizing:CGSizeMake(HistoryImageSize, HistoryImageSize)]];
        }
        NSData *imageData = [NSKeyedArchiver archivedDataWithRootObject:array];
        NgnHistoryImageEvent *imageEvent = [NgnHistoryEvent createImageEventWithStatus:HistoryEventStatus_Incoming andRemoteParty:[[SipStackUtils sharedInstance] getRemotePartyNumber] andContent:imageData];
        imageEvent.start = _starTime;
        imageEvent.end = [[NSDate date] timeIntervalSince1970];
        if (_isIncoming) {
            imageEvent.status = HistoryEventStatus_Incoming;
        }
        else{
            imageEvent.status = HistoryEventStatus_Outgoing;
        }
        [[SipStackUtils sharedInstance].historyService addEvent:(NgnHistoryEvent *)imageEvent];
        if (_addMoreImagesController) {
            [_addMoreImagesController.navigationController popViewControllerAnimated:NO];
        }
    }
    else{
        [_doodlebackView removeFromSuperview];
        [_doodleView removeFromSuperview];
    }
}

- (IBAction)addMoreImage:(id)sender
{
    UIActionSheet *chooesPhoto = [[UIActionSheet alloc] initWithTitle:nil delegate:self cancelButtonTitle:@"取消" destructiveButtonTitle:nil otherButtonTitles:@"相册", @"拍摄", nil];
    [chooesPhoto showInView:self.view];
}

#pragma mark  --ActionSheet Delegate

- (void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (buttonIndex == 1) {
        [self photoFromCamera];
    }
    else if (buttonIndex == 0){
        [self photoFromLibray];
    }
}

- (void)photoFromLibray
{
    UIStoryboard *storyboard = [UIStoryboard storyboardWithName:@"MainStoryboard" bundle:nil];
    AssetGroupPickerController *assetVC = [storyboard instantiateViewControllerWithIdentifier:@"AssetGroupPickerVC"];
    assetVC.delegate = self;
    
    [[SipStackUtils sharedInstance].messageService sendMessage:kAddNewImage  toRemoteParty:[[SipStackUtils sharedInstance] getRemotePartyNumber]];
    UINavigationController *navigationVC = [[UINavigationController alloc] init];
    navigationVC.viewControllers = @[assetVC];
    _addMoreImagesController = navigationVC;
    [self presentViewController:navigationVC animated:YES completion:nil];
}

- (void)photoFromCamera
{
    CameraViewController *cameraCV = [[CameraViewController alloc] init];
    cameraCV.delegate = self;
    UINavigationControllerPortraitViewController *navigationVC = [[UINavigationControllerPortraitViewController alloc] init];
    navigationVC.viewControllers = @[cameraCV];
    [self presentViewController:navigationVC animated:YES completion:nil];
    
//    [[SipStackUtils sharedInstance].messageService sendMessage:kAddNewImage  toRemoteParty:[[SipStackUtils sharedInstance] getRemotePartyNumber]];
}

- (void)doodleWithImageIndex:(NSInteger)index
{
    int ind = [_indexs indexOfObject:[NSString stringWithFormat:@"%d",index]];
    if (ind == NSNotFound) {
        return;
    }
    if (ind >= [_images count]) {
        return;
    }
    [self beginDoodle:ind];
}

- (IBAction)doodle:(id)sender
{
   int index = [_indexs indexOfObject:[NSString stringWithFormat:@"%d",_currentPage - 1]];
    NSString *remotePartyNumber = [[SipStackUtils sharedInstance] getRemotePartyNumber];
    NSString *str = [NSString stringWithFormat:@"%@%@%d",kDoodleImageIndex,kSeparator,_currentPage - 1];
    [[SipStackUtils sharedInstance].messageService sendMessage:str toRemoteParty:remotePartyNumber];
    [self beginDoodle:index];
}

- (void)beginDoodle:(NSInteger)index
{
    UIImage *image = (UIImage *)[_images objectAtIndex:index];
    CGSize imageSize = [self adjustImageFrame:image.size];
    CGRect scrollFrame = _imageScrollView.frame;
    CGRect frame = CGRectMake((320-imageSize.width)/2, (scrollFrame.size.height-imageSize.height)/2, imageSize.width, imageSize.height);
    DoodleView *view = [[DoodleView alloc] initWithFrame:frame];
    _doodleView = view;
    _doodleView.image = image;
    
    DoodleBackView *backView = [[DoodleBackView alloc] initWithFrame:CGRectMake(0, 0, self.view.frame.size.width, self.view.frame.size.height)];
    backView.image = image;
    [backView setImageView:frame];
    _doodlebackView = backView;
    _doodlebackView.backgroundColor = [UIColor whiteColor];
    [self.view addSubview:_doodlebackView];
    [self.view addSubview:_doodleView];
    
    // add doodle toolbar
    CGSize winSize = [UIScreen mainScreen].bounds.size;
    UIView *tool = [[UIView alloc] initWithFrame:CGRectMake(0, winSize.height - 44, 320, 44)];
    _doodleToolBar = tool;
    [self.view addSubview:_doodleToolBar];
    
    UIButton *saveButton = [UIButton buttonWithType:UIButtonTypeRoundedRect];
    [saveButton addTarget:self action:@selector(savePhoto) forControlEvents:UIControlEventTouchUpInside];
    [_doodleToolBar addSubview:saveButton];
    saveButton.frame = CGRectMake(20, 1, 44, 42);
    [saveButton setTitle:@"保存" forState:UIControlStateNormal];

    UIButton *erase = [UIButton buttonWithType:UIButtonTypeRoundedRect];
    [erase addTarget:self action:@selector(erase:) forControlEvents:UIControlEventTouchUpInside];
    [_doodleToolBar addSubview:erase];
    erase.frame = CGRectMake(256, 1, 44, 42);
    [erase setTitle:@"橡皮擦" forState:UIControlStateNormal];
}

- (void)erase:(id)sender
{
    [_doodleView changePaintingMode];
    if (_doodleView.isDrawing) {
        [sender setTitle:@"橡皮擦" forState:UIControlStateNormal];
    }
    else{
        [sender setTitle:@"画笔" forState:UIControlStateNormal];
    }
}

- (void)savePhoto
{
    UIImage *image = [_doodleView screenshot];
    UIImageWriteToSavedPhotosAlbum(image, NULL, NULL, NULL);
}

- (void)hideDoodleTools
{
    [self.navigationController setNavigationBarHidden:!self.navigationController.navigationBarHidden animated:YES];
    [[UIApplication sharedApplication] setStatusBarHidden:self.navigationController.navigationBarHidden];
    [UIView animateWithDuration:0.6 animations:^{
        _doodleToolBar.hidden = !_doodleToolBar.hidden;
    }];

}

#pragma mark    --SelectImagesDelegate--
- (void)didFinishSelectingImage:(NSArray *)images
{
    if ([images count] == 0) {
        return;
    }
    
     __typeof(&*self) __weak weakSelf = self;
    NSString *remotePartyNumber = [[SipStackUtils sharedInstance] getRemotePartyNumber];
    [PictureManager startImageTransSession:[images count] SessionID:[[PictureManager sharedInstance] getImageSession] Success:^(NSInteger baseIndex) {
        NSMutableArray *indexArray = [NSMutableArray array];
        for (int i = 0; i < [images count]; ++i) {
            [indexArray addObject:[NSString stringWithFormat:@"%d", i + baseIndex]];
        }
        [_indexs addObjectsFromArray:indexArray];

        [PictureManager getMaximumIndex:[[PictureManager sharedInstance] getImageSession] Success:^(NSInteger number) {
            _totalNumber = number;
            [weakSelf displayImages];
        }];
        
        [PictureManager putImages:images SessionID:[[PictureManager sharedInstance] getImageSession] StartIndex:baseIndex Receiver:nil Sender:nil  Success:^(NSArray *info) {
            NSString *str = [NSString stringWithFormat:@"%@%@%@",kImagePath,kSeparator,[info objectAtIndex:0]];
            [[SipStackUtils sharedInstance].messageService sendMessage:str toRemoteParty:remotePartyNumber];
        } Completion:^(BOOL finished) {
            [[SipStackUtils sharedInstance].messageService sendMessage:kImageTransCompletion toRemoteParty:remotePartyNumber];
        }];
    }];
    
    [self scrollTO:([_images count]) * PageWidth];
    [_images addObjectsFromArray:images];
    
    [[MainHistoryDataAccessor sharedInstance] updateForRemoteParty:[[SipStackUtils sharedInstance] getRemotePartyNumber] Content:[NSString stringWithFormat:@"Shared Images with %@", [[SipStackUtils sharedInstance] getRemotePartyNumber]] Time:[[NSDate date] timeIntervalSince1970] Type:@"OutGoingImage"];
    
    // 发送信息让对方跳转
    [[SipStackUtils sharedInstance].messageService sendMessage:kNewImageComing toRemoteParty:[[SipStackUtils sharedInstance] getRemotePartyNumber]];
}

- (void)scrollTO:(CGFloat)xoffset
{
    CGPoint point = CGPointMake(xoffset, 0);
    [_imageScrollView setContentOffset:point animated:YES];
    _currentPage = roundf(xoffset / PageWidth) + 1;
    _indicator.text = [NSString stringWithFormat:@"%d / %d",_currentPage,_totalNumber];
}

@end
