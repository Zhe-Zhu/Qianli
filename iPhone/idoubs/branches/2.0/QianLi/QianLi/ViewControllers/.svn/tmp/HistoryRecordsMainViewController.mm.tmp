//
//  HistoryRecordsMainViewController.m
//  QianLi
//
//  Created by Chen Xiangwen on 5/8/13.
//  Copyright (c) 2013 Chen Xiangwen. All rights reserved.
//

#import "HistoryRecordsMainViewController.h"
#import "Reachability.h"
#import "APNsTransUtils.h"

#define CellHeight 80

@interface HistoryRecordsMainViewController ()
{
    NSMutableArray *_historyRecords;
}

@property (weak, nonatomic) IBOutlet UITableView *historyTableView;
@property (weak, nonatomic) HistroyRecordDetailsViewController *detailCV;

@end

@implementation HistoryRecordsMainViewController

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}

- (void)viewDidLoad
{
    [super viewDidLoad];
	// Do any additional setup after loading the view.
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(receiveAppointment:) name:@"receivedImageNotification" object:nil];
    _historyTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    //[[MainHistoryDataAccessor sharedInstance] deleteObjectForRemoteParty:@"666666"];
}

- (void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    NSIndexPath *selectdPath = [_historyTableView indexPathForSelectedRow];
    [_historyTableView deselectRowAtIndexPath:selectdPath animated:YES];
    // Connect to server to get unanwsered calls
    [self displayHistory];
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (void)dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}

- (NSUInteger)supportedInterfaceOrientations
{
    return UIInterfaceOrientationMaskPortrait;
}

- (void)displayHistory
{
    [self loadHistory];
    [self.historyTableView reloadData];
}

- (void)loadHistory
{
    if (!_historyRecords) {
        _historyRecords = [[NSMutableArray alloc] initWithCapacity:1];
    }
    else{
        [_historyRecords removeAllObjects];
    }
    
    // Sort the entries in history array
    NSSortDescriptor *sortDescriptor;
    sortDescriptor = [[NSSortDescriptor alloc] initWithKey:@"time" ascending:NO];
    NSArray *sortDescriptors = [NSArray arrayWithObject:sortDescriptor];
    NSMutableArray *sortedArray;
    
    sortedArray = [NSMutableArray arrayWithArray:[[NSMutableArray arrayWithArray:[[MainHistoryDataAccessor sharedInstance] getAllObjects]] sortedArrayUsingDescriptors:sortDescriptors]];
    for (int i = 0; i < [sortedArray count]; ++i) {
        NSManagedObject *object = [sortedArray objectAtIndex:i];
        MainHistoryEntry *entry = [[MainHistoryEntry alloc] init];
        entry.content = [object valueForKey:@"content"];
        entry.remoteParty = [object valueForKey:@"remoteParty"];
        entry.time = [[object valueForKey:@"time"] doubleValue];
        entry.type = [object valueForKey:@"type"];
        entry.name = [[QianLiContactsAccessor sharedInstance] getNameForRemoteParty:[object valueForKey:@"remoteParty"]];
        entry.profile = [[QianLiContactsAccessor sharedInstance] getProfileForRemoteParty:[object valueForKey:@"remoteParty"]];
        [_historyRecords addObject:entry];
    }
}

- (void)restoreHistory
{
    [self loadHistory];
    if (_detailCV) {
        [_detailCV loadDetailHistory];
    }
}

- (void)clearHistory
{
    [_historyRecords removeAllObjects];
    if (_detailCV) {
        [_detailCV clearDetailHistory];
    }
}

# pragma mark - UITableView Delegate

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return CellHeight;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return [_historyRecords count];
}

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView
{
    return 1;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    MainHistoryEntry *entry = (MainHistoryEntry *) [_historyRecords objectAtIndex:indexPath.row];
    
    static NSString *CellIdentifier = @"HistoryMainCell";
	HistoryMainCell *historyCell = (HistoryMainCell *)[tableView dequeueReusableCellWithIdentifier:CellIdentifier];
    // 因为所继承的cell每次都把view清理,所以每次都要重新Init一遍,否则backview会丢失
//	if (historyCell == nil) {
//		historyCell = [[HistoryMainCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:CellIdentifier];
//    }
    historyCell = [[HistoryMainCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:CellIdentifier];
    historyCell.historyMainCelldelegate = self;
    [historyCell setHistoryMainCell:@"lg" avatar:entry.profile Name:entry.name Time:[Utils readableTimeFromSecondsSince1970LikeWeixin:entry.time] Content:entry.content];
    
    if ([entry.type isEqualToString:@"Appointment"]) {
        [historyCell activateRequestStatus];
    }
    
    //TODO: 测试用 记得删除
//    [historyCell activateRequestStatus];
    
    return historyCell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    UIStoryboard *storyboard = [UIStoryboard storyboardWithName:@"MainStoryboard" bundle:nil];
    _detailCV = [storyboard instantiateViewControllerWithIdentifier:@"HistoryDetailController"];
    MainHistoryEntry *entry = (MainHistoryEntry *) [_historyRecords objectAtIndex:indexPath.row];
    _detailCV.title = entry.name;
    _detailCV.remotePartyPhoneNumber = entry.remoteParty;
    // 进入detailView时自动隐藏Tabbar
    _detailCV.hidesBottomBarWhenPushed = YES;
    // TODO: Do some initialization
    
    [self.navigationController pushViewController:_detailCV animated:YES];
}

#pragma mark -- HistoryMainCellDelegate --
- (void)sendRequest:(HistoryMainCell *)historyMainCell
{
    if (![Utils checkInternet]) {
        return;
    }
    // send some request
    [NSTimer scheduledTimerWithTimeInterval:0.8 target:historyMainCell selector:@selector(stopSpin) userInfo:nil repeats:NO];
    NSIndexPath *indexPath = [_historyTableView indexPathForCell:historyMainCell];
    MainHistoryEntry *entry = (MainHistoryEntry *)[_historyRecords objectAtIndex:indexPath.row];
    NSString *message = [NSString stringWithFormat:@"%@%@%@", kAppointment,kSeparator,[UserDataAccessor getUserRemoteParty]];
    [[SipStackUtils sharedInstance].messageService sendMessage:message toRemoteParty:entry.remoteParty];
    
    // Add to history record TODO: modify the media_type of the event
    NgnHistoryAVCallEvent *event = [[NgnHistoryAVCallEvent alloc] init:NO withRemoteParty:entry.remoteParty];
    event.status = HistoryEventStatus_Appointment;
    [[SipStackUtils sharedInstance].historyService addEvent:event];

    [[MainHistoryDataAccessor sharedInstance] updateForRemoteParty:entry.remoteParty Content:[NSString stringWithFormat:@"Appointment for %@",entry.name] Time:[[NSDate date] timeIntervalSince1970] Type:@"MakeAppointment"];
    [self displayHistory];
    
    // send push notification
}

- (void)cancelRequest:(HistoryMainCell *)historyMainCell
{
    NSIndexPath *indexPath = [_historyTableView indexPathForCell:historyMainCell];
    MainHistoryEntry *entry = (MainHistoryEntry *)[_historyRecords objectAtIndex:indexPath.row];
    [[MainHistoryDataAccessor sharedInstance] updateForRemoteParty:entry.remoteParty Content:@"" Time:[[NSDate date] timeIntervalSince1970] Type:@"AppointmentCancelled"];
    [self displayHistory];
}

- (void)makeACall:(HistoryMainCell *)historyMainCell
{
    NSIndexPath *indexPath = [_historyTableView indexPathForCell:historyMainCell];
    MainHistoryEntry *entry = (MainHistoryEntry *)[_historyRecords objectAtIndex:indexPath.row];
    [self call:entry.remoteParty];
}

- (void)receiveAppointment:(NSNotification *)notification
{
    NSString *info = notification.object;
    NSArray* words = [info componentsSeparatedByString:kSeparator];
    if ([[words objectAtIndex:0] isEqualToString:kAppointment]) {
        [[MainHistoryDataAccessor sharedInstance] updateForRemoteParty:[words objectAtIndex:1] Content:[NSString stringWithFormat:@"Appointment from %@", [[QianLiContactsAccessor sharedInstance] getNameForRemoteParty:[words objectAtIndex:1]]] Time:[[NSDate date] timeIntervalSince1970] Type:@"Appointment"];
        
        [self displayHistory];
        
        NgnHistoryAVCallEvent *event = [[NgnHistoryAVCallEvent alloc] init:NO withRemoteParty:[words objectAtIndex:1]];
        event.status = HistoryEventStatus_Appointment;
        [[SipStackUtils sharedInstance].historyService addEvent:event];
    }
}

// TODO: 考虑把call作为全局函数, 目前太多相同的地方了
- (void)call:(NSString *)remotePartyPhoneNumber
{
    if ([remotePartyPhoneNumber isEqualToString:[UserDataAccessor getUserRemoteParty]]) {
        return;
    }
    
    if (![Utils checkInternet]) {
        return;
    }
    
    UIStoryboard *storyboard = [UIStoryboard storyboardWithName:@"MainStoryboard" bundle:nil];
    UINavigationController *audioCallNavigationController = [storyboard instantiateViewControllerWithIdentifier:@"audioCallNavigationController"];
    QianLiAudioCallViewController *audioCallViewController = (QianLiAudioCallViewController *)audioCallNavigationController.topViewController;
    audioCallViewController.ViewState = Calling;
    [self presentViewController:audioCallNavigationController animated:YES completion:nil];
    
    [[SipStackUtils sharedInstance] setRemotePartyNumber:remotePartyPhoneNumber];
    NSString *remoteUri  = [[SipStackUtils sharedInstance] getRemotePartyNumber];
    
    long sID;
    if([[SipStackUtils sharedInstance].audioService makeAudioCallWithRemoteParty:remoteUri andSipStack:[[SipStackUtils sharedInstance].sipService getSipStack]  sessionid:&sID])
    {
        audioCallViewController.audioSessionID = sID;
        audioCallViewController.remotePartyNumber = remoteUri;
        NSString *imageSessionID = [NSString stringWithFormat:@"%@%@",[UserDataAccessor getUserRemoteParty],remoteUri];
        [[PictureManager sharedInstance] setImageSession:imageSessionID];
        
        // Add to history record
        NgnHistoryAVCallEvent *event = [[NgnHistoryAVCallEvent alloc] init:NO withRemoteParty:remotePartyPhoneNumber];
        audioCallViewController.activeEvent = event;
        event.status = HistoryEventStatus_Outgoing;
        //[[SipStackUtils sharedInstance].historyService addEvent:event];
        
        // Add to main recent
        [[MainHistoryDataAccessor sharedInstance] updateForRemoteParty:remotePartyPhoneNumber Content:[NSString stringWithFormat:@"Called %@",[[QianLiContactsAccessor sharedInstance] getNameForRemoteParty:remotePartyPhoneNumber]] Time:[[NSDate date] timeIntervalSince1970] Type:@"OutGoindCall"];
    }
    else{
    }
}

@end
